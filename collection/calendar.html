<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Calendar</title>
<style type="text/css" rel="stylesheet">
.ycalendar {
    position: absolute;
    z-index: 600;
    width: 210px;
    font-family: 'PingFang SC', 'Helvetica', 'Microsoft YaHei', 'Arial', 'sans-serif';
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.ycalendar-table {
    width: 100%;
    height: 100%;
    text-align: center;
    border: none;
    border-collapse: collapse;
}
.ycalendar-table td {padding: 0;}
.ycalendar-table label {
    display: inline-block;
    width: 100%;
    height: 100%;
}
.ycalendar-table label:hover {
    cursor: pointer;
    background-color: #ccc;
}

/* title */
.ycalendar-header {
    line-height: 36px;
    font-size: 14px;
    background-color: #f5f5f5;
    border-bottom: 1px solid #ddd;
}

/* content */
.ycalendar-content {
    position: relative;
}

/* content -> week */
.ycalendar-week {
    line-height: 32px;
    font-size: 12px;
    background-color: #f5f5f5;
    border-bottom: 1px solid #ddd;
}

/* content -> days */
.ycalendar-day {
    font-size: 12px;
}
.ycalendar-day span {
    display: inline-block;
    width: 14.28%;
    height: 28px;
    line-height: 28px;
    color: #222;
    text-align: center;
    border-radius: 4px;
}
.ycalendar-day span[data-invalid],
.ycalendar-day span[data-disabled] {
    color: #aaa;
}
.ycalendar-day span:hover {
    cursor: pointer;
    background-color: #eee;
}
.ycalendar-day span.active {
    color: #fff;
    background-color: #216ba5;
}

/* content -> poplay */
.ycalendar-poplay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    font-size: 12px;
    background-color: #fff;
    display: none;
}
.ycalendar-poplay-item-number {
    display: inline-block;
    width: 25%;
    height: 33%;
    text-align: center;
    background-color: #fff;
}
.ycalendar-poplay-item-number:hover,
.ycalendar-poplay-item-number.active {
    background-color: #aeaeae;
}
.ycalendar-time {
    position: absolute;
    left: 211px;
    top: -1px;
    width: 70px;
    height: 100%;
    background-color: #fff;
    overflow: auto;
    border: 1px solid #ddd;
    border-left: 0;
    border-radius: 4px;
}
.ycalendar-time div {
    line-height: 36px;
    font-size: 12px;
    text-align: center;
    cursor: pointer;
}
.ycalendar-time div:hover {
    background-color: #f0f0f0;
}
.ycalendar-time div.active {
    color: #fff;
    background-color: #216ba5;
}

</style>
</head>
<body>
<input type="text" id="time" value="">   

<script>
function YCalendar(options) {
    this.doc = document;
    
    this.wrapper = null;
    this.options = {
        targetId: '',
        zIndex: 600,
        format: 'y-m-d h:i:s',
        onPickDate: null,
        showTime: true,
        timeIntervals: 15
    };
    
    this.hasMount = false;
    
    this.initOptions(options);
    this.initDom();
    this.initEvent();
}
YCalendar.prototype = {
    constructor: YCalendar,
    initDate: function(date) {
        var d = ('' === date || undefined === date)
            ? new Date() : new Date( date.replace(/-/g, '/') );
        
        this.year = d.getFullYear();
        this.month = d.getMonth() + 1;
        this.date = d.getDate();
        this.hours = d.getHours();
        this.minutes = d.getMinutes();
        this.seconds = d.getSeconds();
    },
    initOptions: function(options) {
        if(undefined === options) {
            return;
        }
        
        for(var k in options) {
            this.options[k] = options[k];
        }
    },
    initDom: function() {
        this.wrapper = this.doc.createElement('div');
        this.wrapper.className = 'ycalendar';
        this.wrapper.style.zIndex = this.options.zIndex;
    },
    initEvent: function() {
        var _self = this;
        
        this.wrapper.onclick = function(e) {
            e.stopPropagation && e.stopPropagation();
            
            _self.handlerEvent(e);
        };
        
        var targetObject = this.doc.getElementById(this.options.targetId);
        targetObject.onclick = function(e) {
            _self.mount();
        };
        targetObject = null;
        
        this.doc.body.addEventListener('click', function(e) {
            if(e.target.getAttribute('id') === _self.options.targetId) {
                return;
            }
            
            _self.unMount();
        });
    },
    lPad: function(str, pad, length) {
        while(str.length < length) {
            str = pad + str;
        }
        
        return str;
    },
    handlerEvent: function(e) {
        e = e || window.event;
        
        var target = e.target || e.srcElement;
        
        if('I' === target.nodeName.toUpperCase()
            || 'EM' === target.nodeName.toUpperCase()) {
            
            target = target.parentNode;
        }
        
        switch(target.getAttribute('data-action')) {
            case 'lastYear':
                this.year--;
                this.render();
                
                break;
            case 'nextYear':
                this.year++;
                this.render();
                
                break;
            case 'lastMonth':
                if(1 === this.month) {
                    //this.year--;
                    this.month = 12;
                    
                } else {
                    this.month--;
                }
                this.render();
                
                break;
            case 'nextMonth':
                if(12 === this.month) {
                    //this.year++;
                    this.month = 1;
                    
                } else {
                    this.month++;
                }
                this.render();
                
                break;
            case 'selectYear':
                this.popYear(this.year);
                
                // show
                this.togglePoplay();
                
                break;
            case 'pickYear':
                if('1' === target.getAttribute('data-disabled')) {
                    return;
                }
            
                var year = target.getAttribute('data-value');
                this.year = parseInt(year, 10);
                this.render();
                
                break;
            case 'selectMonth':
                this.popMonth();
                
                // show
                this.togglePoplay();
                
                break;
            case 'pickMonth':
                var month = target.getAttribute('data-value');
                this.month = parseInt(month, 10);
                this.render();
                
                break;
            case 'pickDay':
                if('1' === target.getAttribute('data-disabled')) {
                    return;
                }
            
                var str = target.getAttribute('data-value');
                var arr = str.split('-');
                
                //this.year = parseInt(arr[0], 10);
                this.month = parseInt(arr[1], 10);
                this.date = parseInt(arr[2], 10);
                
                // 如果没有时间 那么直接填充时间到页面
                // 否则 需要选择时间后再填充页面
                if(this.options.showTime) {
                    this.render();
                    
                } else {
                    this.fillDate();
                    this.unMount();
                }
                
                break;
            case 'pickTime':
                var str = target.getAttribute('data-value');
                var arr = str.split(':');
                
                this.hours = parseInt(arr[0], 10);
                this.minutes = parseInt(arr[1], 10);
                
                this.fillDate();
                this.unMount();
                
                break;
            default:
                break;
        }
    },
    appendHtml: function(html, firstAppend) {
        if(firstAppend) {
            this.wrapper.innerHTML = html;
            
            return;
        }
        
        this.wrapper.innerHTML += html;
    },
    getDaysOfMonth: function(year, month) {
        if(0 === month) {
            year = year - 1;
            month = 12;
        }
        if(13 === month) {
            year = year + 1;
            month = 1;
        }
        
        if(2 === month) {
            if(0 === year % 400 || (0 === year % 4 && 0 !== year % 100)) {
                return 29;
            }
            
            return 28;
        }
        
        if(4 === month || 6 === month || 9 === month || 11 === month) {
            return 30;
        }
        
        return 31;
    },
    renderHeader: function() {
        var title =
        ['<section class="ycalendar-header">',
            '<table class="ycalendar-table">',
                '<tr>',
                    '<td><label data-action="lastYear">◄</label></td>',
                    '<td><label data-action="selectYear">'+ this.year +'</label></td>',
                    '<td><label data-action="nextYear">►</label></td>',
                    '<td><label data-action="lastMonth">◄</label></td>',
                    '<td><label data-action="selectMonth">'+ this.month +'</label></td>',
                    '<td><label data-action="nextMonth">►</label></td>',
                '</tr>',
            '</table>',
        '</section>'].join('');
        
        this.appendHtml(title, true);
    },
    renderContent: function() {
        // start
        var content = '<section class="ycalendar-content">';
        
        // week
        content += this.getWeekString();
        
        // day
        content += this.getDayString();
        
        // poplay
        content += '<div class="ycalendar-poplay"></div>';
        
        // end
        content += '</section>';
        
        this.appendHtml(content);
    },
    renderTime: function() {
        var html = '<section class="ycalendar-time">';
        
        // 从选定的时间 或者 当前时间开始循环
        var interval = this.options.timeIntervals;
        var startHour = new Date().getHours();
        var startMinute = 0;
        if(undefined !== this.minutes && 0 === this.minutes % interval) {
            startHour = this.hours;
            startMinute = this.minutes;
        }
        
        var tmp = '';
        // 后面的时间
        for(var h=startHour; h<24; h++) {
            for(var m=startMinute; m<60; m = m + interval) {
                tmp += '<div class="'+ (this.hours === h && this.minutes === m ? 'active' : '') +'" data-action="pickTime" data-value="'+ h + ':' + m +'">'
                    + h + ':' + this.lPad(String(m), '0', 2)
                    + '</div>';
            }
            
            // 下一个小时的分钟正常从 0 开始
            startMinute = 0;
        }
        // 前面的时间
        for(var h=0; h<startHour; h++) {
            for(var m=startMinute; m<60; m = m + interval) {
                tmp += '<div data-action="pickTime" data-value="'+ h + ':' + m +'">'
                    + h + ':' + this.lPad(String(m), '0', 2)
                    + '</div>';
            }
        }
        
        html += tmp;
        html += '</section>';
        
        this.appendHtml(html)
    },
    getWeekString: function() {
        var week =
        ['<div class="ycalendar-week">',
            '<table class="ycalendar-table">',
                '<tr>',
                    '<td>日</td>',
                    '<td>一</td>',
                    '<td>二</td>',
                    '<td>三</td>',
                    '<td>四</td>',
                    '<td>五</td>',
                    '<td>六</td>',
                '</tr>',
            '</table>',
        '</div>'].join('');
        
        return week;
    },
    getDayString: function() {
        var html = '<div class="ycalendar-day"><div data-role="line">';
        
        var days = this.getDaysOfMonth(this.year, this.month);
        var startWeek = new Date(this.year, this.month - 1, 1).getDay();
        var lastMonthDays = this.getDaysOfMonth(this.year, this.month - 1);
        var nextMonthDays = this.getDaysOfMonth(this.year, this.month + 1);
        // 占满 6 行
        var totalDays = 42;
        
        // 向上个月补齐
        for(var i=startWeek; i>0; i--) {
            html += '<span data-action="pickDay" data-invalid="1" data-value="'+ this.year + '-' + (this.month - 1) + '-' + (lastMonthDays - i + 1) +'">'
                + (lastMonthDays - i + 1)
                +'</span>';
                
            totalDays--;
            
            // 换行
            if(0 === totalDays % 7) {
                html += '</div><div data-role="line">';
            }
        }
        
        // 本月
        for(var j=1; j<=days; j++) {
            if(j === this.date) {
                html += '<span class="active" data-action="pickDay" data-value="'+ this.year + '-' + this.month + '-' + j +'">'
                    + j +'</span>';
                
            } else {
                html += '<span data-action="pickDay" data-value="'+ this.year + '-' + this.month + '-' + j +'">'
                    + j +'</span>';
            }
            
            totalDays--;
            
            // 换行
            if(0 === totalDays % 7) {
                html += '</div><div data-role="line">';
            }
        }
        
        // 向下个月补齐
        for(var k=1; k<=nextMonthDays; k++) {
            html += '<span data-action="pickDay" data-invalid="1" data-value="'+ this.year + '-' + (this.month + 1) + '-' + k +'">'
                + k +'</span>';
            
            totalDays--;
            
            if(totalDays <= 0) {
                break;
            }
            
            // 换行
            if(0 === totalDays % 7) {
                html += '</div><div data-role="line">';
            }
        }
        
        html += '</div></div>';
        
        return html;
    },
    render: function() {
        this.renderHeader();
        
        this.renderContent();
        
        if(this.options.showTime) {
            this.renderTime();
        }
    },
    getPopLay: function() {
        return this.wrapper.querySelector('.ycalendar-poplay');
    },
    togglePoplay: function() {
        var popLay = this.getPopLay();
    
        if('block' === popLay.style.display) {
            popLay.style.display = 'none';
            
            return;
        }
        
        popLay.style.display = 'block';
    },
    popYear: function(startYear) {
        var popLay = this.getPopLay();
        var ret = '';
        
        for(var i=0,tmp=''; i<12; i++) {
            tmp = this.year === startYear + i ? 'active' : '';
            ret += '<span class="ycalendar-poplay-item-number '+ tmp +'" data-action="pickYear" data-value="'+ (startYear + i) +'">'+ (startYear + i) +'</span>';
        }
        
        popLay.innerHTML = ret;
    },
    popMonth: function() {
        var popLay = this.getPopLay();
        var ret = '';
        
        for(var i=1; i<=12; i++) {
            ret += '<span class="ycalendar-poplay-item-number" data-action="pickMonth" data-value="'+ i +'">'+ i +'</span>';
        }
        
        popLay.innerHTML = ret;
    },
    fillDate: function() {
        var _self = this;
        var funs = {
            y: function() {
                return _self.year;
            }
            ,m: function() {
                return _self.lPad(String(_self.month), '0', 2);
            }
            ,d: function() {
                return _self.lPad(String(_self.date), '0', 2);
            }
            ,h: function() {
                return _self.lPad(String(_self.hours), '0', 2);
            }
            ,i: function() {
                return _self.lPad(String(_self.minutes), '0', 2);
            }
            ,s: function() {
                return _self.lPad(String(_self.seconds), '0', 2);
            }
        };
        
        var ret = this.options.format.replace(/(.?)/ig, function(match, p/* , offset, string */) {
            return undefined !== funs[match] ?
                funs[match]() :
                p;
        });
        
        // 填充时间
        this.doc.getElementById(this.options.targetId).value = ret;
        
        if(null !== this.options.onPickDate) {
            this.options.onPickDate(ret);
        }
    },
    unMount: function() {
        if(!this.hasMount) {
            return;
        }
    
        this.doc.body.removeChild(this.wrapper);
        
        this.hasMount = false;
    },
    mount: function() {
        if(this.hasMount) {
            return;
        }
        this.hasMount = true;
    
        var targetObject = this.doc.getElementById(this.options.targetId);
    
        // 定位日期
        this.initDate(targetObject.value);
    
        this.doc.body.appendChild(this.wrapper);
           
        this.render();
    }
};


// ==========
new YCalendar({
    targetId: 'time',
    showTime: true,
    //timeIntervals: 30,
    format: 'y-m-d h:i',
    onPickDate: function(v) {
        console.log(v)
    }
});
</script>
</body>
</html>
